# 빠른 시작 가이드

이 가이드에서는 Tistory2Wordpress 도구를 사용하여 티스토리 블로그를 워드프레스로 마이그레이션하는 방법을 설명합니다.

## 목차

1. [사전 요구사항](#사전-요구사항)
2. [설치](#설치)
3. [설정](#설정)
4. [기본 사용법](#기본-사용법)
5. [북마크 처리](#북마크-처리)
6. [이관 흐름](#이관-흐름)
7. [데이터베이스](#데이터베이스)
8. [문제 해결](#문제-해결)

## 사전 요구사항

- Node.js 18 이상
- npm 또는 yarn
- 워드프레스 사이트 (REST API 활성화)
- 워드프레스 애플리케이션 비밀번호

### 워드프레스 애플리케이션 비밀번호 생성

워드프레스 관리자 페이지에서 애플리케이션 비밀번호를 생성하세요:

1. 워드프레스 관리자 페이지 로그인
2. 사용자 → 프로필 이동
3. "애플리케이션 비밀명" 섹션에서 새 비밀번호 생성
4. 생성된 비밀번호를 복사 (예: `abcd 1234 efgh 5678 ijkl`)

## 설치

```bash
# 저장소 복제
git clone <repository-url>
cd Tistory2Wordpress

# 의존성 설치
npm install

# 빌드
npm run build
```

## 설정

### 1. 환경변수 파일 생성

```bash
cp .env.example .env
```

### 2. 필수 환경변수 설정

#### 티스토리 블로그 URL

| 변수 | `TISTORY_BLOG_URL`                                                                                  |
| ---- | --------------------------------------------------------------------------------------------------- |
| 용도 | 마이그레이션할 티스토리 블로그 주소를 지정합니다                                                    |
| 예시 | `https://yourblog.tistory.com`                                                                      |
| 설명 | 티스토리 블로그의 메인 URL입니다. 이 주소에서 포스트 목록을 발견하고 각 포스트의 HTML을 fetch합니다 |

```bash
TISTORY_BLOG_URL=https://yourblog.tistory.com
```

#### 워드프레스 REST API 설정

| 변수 | `WP_BASE_URL`                       |
| ---- | ----------------------------------- |
| 용도 | 워드프레스 설치 주소를 지정합니다   |
| 예시 | `https://your-wordpress-site.com`   |
| 설명 | 워드프레스 사이트의 기본 URL입니다. |

| 변수 | `WP_APP_USER`                                              |
| ---- | ---------------------------------------------------------- |
| 용도 | 워드프레스 로그인 사용자명을 지정합니다                    |
| 예시 | `admin` 또는 `your-username`                               |
| 설명 | 워드프레스 관리자 계정의 사용자명입니다. 인증에 사용됩니다 |

| 변수 | `WP_APP_PASSWORD`                                                                                                                               |
| ---- | ----------------------------------------------------------------------------------------------------------------------------------------------- |
| 용도 | 워드프레스 애플리케이션 비밀번호를 지정합니다                                                                                                   |
| 예시 | `abcd 1234 efgh 5678 ijkl`                                                                                                                      |
| 설명 | 워드프레스 관리자 페이지에서 생성한 애플리케이션 비밀번호입니다. 일반 비밀번호가 아닙니다. 사용자 → 프로필 → 애플리케이션 비밀명에서 생성하세요 |

```bash
# 워드프레스 REST API
WP_BASE_URL=https://your-wordpress-site.com
WP_APP_USER=your-wordpress-username
WP_APP_PASSWORD=abcd 1234 efgh 5678 ijkl
```

### 3. 티스토리 CSS 선택자 설정

티스토리 블로그 테마에 맞게 CSS 선택자를 설정해야 합니다. 브라우저 개발자 도구를 사용하여 각 요소의 CSS 선택자를 확인하고 `.env` 파일에 설정하세요.

#### 포스트 링크 선택자

| 변수 | `TISTORY_SELECTOR_POST_LINK`                                                                                                           |
| ---- | -------------------------------------------------------------------------------------------------------------------------------------- |
| 용도 | 티스토리 리스트 페이지에서 포스트 링크를 찾습니다                                                                                      |
| 예시 | `a.link_category`                                                                                                                      |
| 설명 | 전체 블로그 이관 시, 크롤러가 모든 포스트 URL을 발견하기 위해 사용합니다. href가 옮길 포스트 링크를 가리키는 a tag의 선택자여야 합니다 |

#### 포스트 메타데이터 선택자

| 변수 | `TISTORY_SELECTOR_TITLE`                                                               |
| ---- | -------------------------------------------------------------------------------------- |
| 용도 | 포스트 제목을 추출합니다                                                               |
| 예시 | `meta[name="title"]`                                                                   |
| 설명 | 워드프레스 포스트의 제목으로 사용됩니다. `<meta>` 태그의 `content` 속성에서 추출합니다 |

| 변수 | `TISTORY_SELECTOR_PUBLISH_DATE`                                                              |
| ---- | -------------------------------------------------------------------------------------------- |
| 용도 | 포스트 발행일을 추출합니다                                                                   |
| 예시 | `meta[property="article:published_time"]`                                                    |
| 설명 | ISO 8601 형식 날짜 문자열이어야 합니다. 워드프레스 포스트의 발행일(`post_date`)로 설정됩니다 |

| 변수 | `TISTORY_SELECTOR_MODIFIED_DATE`                                                                 |
| ---- | ------------------------------------------------------------------------------------------------ |
| 용도 | 포스트 수정일을 추출합니다                                                                       |
| 예시 | `meta[property="article:modified_time"]`                                                         |
| 설명 | ISO 8601 형식 날짜 문자열이어야 합니다. 워드프레스 포스트의 수정일(`post_modified`)로 설정됩니다 |

| 변수 | `TISTORY_SELECTOR_CATEGORY`                                                     |
| ---- | ------------------------------------------------------------------------------- |
| 용도 | 포스트 카테고리를 추출합니다                                                    |
| 예시 | `div.another_category h4 a`                                                     |
| 설명 | 포스트에 할당된 카테고리 이름(들)을 추출합니다. 콤마로 구분된 경우도 지원합니다 |

| 변수 | `TISTORY_SELECTOR_TAG`                     |
| ---- | ------------------------------------------ |
| 용도 | 포스트 태그를 추출합니다                   |
| 예시 | `div.area_tag a[rel="tag"]`                |
| 설명 | 포스트에 할당된 태그 이름(들)을 추출합니다 |

```bash
# 포스트 메타데이터 선택자
TISTORY_SELECTOR_TITLE=meta[name="title"]
TISTORY_SELECTOR_PUBLISH_DATE=meta[property="article:published_time"]
TISTORY_SELECTOR_MODIFIED_DATE=meta[property="article:modified_time"]
TISTORY_SELECTOR_CATEGORY=div.another_category h4 a
TISTORY_SELECTOR_TAG=div.area_tag a[rel="tag"]
```

#### 포스트 컨텐츠 선택자

| 변수 | `TISTORY_SELECTOR_CONTENT`                                                                            |
| ---- | ----------------------------------------------------------------------------------------------------- |
| 용도 | 포스트 본문 컨텐츠를 추출합니다                                                                       |
| 예시 | `div.tt_article_useless_p_margin.contents_style`                                                      |
| 설명 | 포스트의 실제 내용이 포함된 HTML 요소를 지정합니다. 이 영역의 HTML만 정제되어 워드프레스로 전송됩니다 |

| 변수 | `TISTORY_SELECTOR_FEATURED_IMAGE`                                                           |
| ---- | ------------------------------------------------------------------------------------------- |
| 용도 | 포스트 대표이미지를 추출합니다                                                              |
| 예시 | `#main > div > div > div.article_header.type_article_header_cover > div"`                   |
| 설명 | 대표이미지 URL을 포함하는 요소를 지정합니다. URL이나 `<img>` 태그의 `src` 속성을 추출합니다 |

```bash
# 포스트 컨텐츠 선택자
TISTORY_SELECTOR_CONTENT=div.tt_article_useless_p_margin.contents_style
TISTORY_SELECTOR_FEATURED_IMAGE="#main > div > div > div.article_header.type_article_header_cover > div"
```

### 4. 북마크 설정

#### 북마크 선택자

| 변수 | `TISTORY_BOOKMARK_SELECTOR`                                                                                                                                                                                |
| ---- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 용도 | 티스토리 북마크(웹사이트 미리보기)를 감지합니다                                                                                                                                                            |
| 예시 | `figure[data-ke-type="opengraph"]`                                                                                                                                                                         |
| 설명 | 티스토리 포스트의 북마크 요소를 식별합니다. 각 북마크 내의 `<a>` 태그의 `href` 속성에서 URL을 추출합니다. 추출된 URL에서 OpenGraph 메타데이터를 fetch하고 워드프레스에 표준화된 북마크 카드로 렌더링합니다 |

```bash
# 북마크 감지 CSS 선택자
TISTORY_BOOKMARK_SELECTOR=figure[data-ke-type="opengraph"]
```

### 5. 선택적 환경변수

#### 작업자 풀 설정

| 변수   | `WORKER_COUNT`                                                                                                                     |
| ------ | ---------------------------------------------------------------------------------------------------------------------------------- |
| 용도   | 동시에 처리할 작업자 수                                                                                                            |
| 기본값 | `4`                                                                                                                                |
| 범위   | 1-16                                                                                                                               |
| 설명   | 여러 포스트를 병렬로 이관할 때 사용할 작업자 수입니다. 높일수록 이관이 빨라지지만 티스토리/워드프레스 서버에 더 많은 부하를 줍니다 |

| 변수   | `RATE_LIMIT_PER_WORKER`                                                                                          |
| ------ | ---------------------------------------------------------------------------------------------------------------- |
| 용도   | 각 작업자가 요청 간에 대기할 시간 (ms)                                                                           |
| 기본값 | `1000` (1초)                                                                                                     |
| 설명   | 작업자당 요청 속도를 제한합니다. 너무 낮으면 서버에서 차단될 수 있습니다. 보수적: 1000-2000ms, 적극적: 200-500ms |

```bash
# 작업자 풀 설정
WORKER_COUNT=4
RATE_LIMIT_PER_WORKER=1000
```

#### 출력 설정

| 변수   | `OUTPUT_DIR`                                     |
| ------ | ------------------------------------------------ |
| 용도   | 생성된 파일들을 저장할 디렉토리 경로             |
| 기본값 | `./output`                                       |
| 설명   | 링크 매핑 JSON 파일 등이 저장되는 디렉토리입니다 |

| 변수   | `MIGRATION_DB_PATH`                                                                      |
| ------ | ---------------------------------------------------------------------------------------- |
| 용도   | 이관 상태를 저장할 SQLite DB 파일 경로                                                   |
| 기본값 | `./data/migration.db`                                                                    |
| 설명   | 마이그레이션 작업, 포스트 상태, 이미지 업로드 상태 등을 추적하는 데이터베이스 파일입니다 |

| 변수   | `LOG_LEVEL`                                                                 |
| ------ | --------------------------------------------------------------------------- |
| 용도   | 로그 레벨                                                                   |
| 기본값 | `info`                                                                      |
| 옵션   | `debug`, `info`, `warn`, `error`                                            |
| 설명   | `debug`: 모든 정보 출력, `info`: 일반 정보, `warn`: 경고만, `error`: 에러만 |

| 변수   | `LOG_FILE`                                                                      |
| ------ | ------------------------------------------------------------------------------- |
| 용도   | 로그를 파일로 저장할 경로                                                       |
| 기본값 | 없음 (콘솔만 출력)                                                              |
| 설명   | 지정하면 로그가 파일에도 저장됩니다. 경로는 상대 또는 절대 경로 모두 가능합니다 |

```bash
# 출력 설정
OUTPUT_DIR=./output
MIGRATION_DB_PATH=./data/migration.db
LOG_LEVEL=info
LOG_FILE=./output/migration.log
```

#### 재시도 설정

| 변수   | `MAX_RETRY_ATTEMPTS`                 |
| ------ | ------------------------------------ |
| 용도   | HTTP 요청 실패 시 재시도할 최대 횟수 |
| 기본값 | `3`                                  |
| 설명   | 최대 재시도 횟수                     |

| 변수   | `RETRY_INITIAL_DELAY_MS`                                                     |
| ------ | ---------------------------------------------------------------------------- |
| 용도   | 재시도 시 첫 번째 대기 시간 (ms)                                             |
| 기본값 | `500` (0.5초)                                                                |
| 설명   | 첫 번째 재시도 전에 대기할 시간입니다. 이후 재시도에서는 백오프로 증가합니다 |

| 변수   | `RETRY_MAX_DELAY_MS`          |
| ------ | ----------------------------- |
| 용도   | 재시도 시 최대 대기 시간 (ms) |
| 기본값 | `10000` (10초)                |
| 설명   | 재시도 대기 시간의 상한입니다 |

| 변수   | `RETRY_BACKOFF_MULTIPLIER`                                                 |
| ------ | -------------------------------------------------------------------------- |
| 용도   | 재시도할 때마다 대기 시간을 늘리는 배수                                    |
| 기본값 | `2`                                                                        |
| 설명   | 지수적 백오프에 사용됩니다. 각 재시도 후 대기 시간 = 이전 대기 시간 × 배수 |

```bash
# 재시도 설정
MAX_RETRY_ATTEMPTS=3
RETRY_INITIAL_DELAY_MS=500
RETRY_MAX_DELAY_MS=10000
RETRY_BACKOFF_MULTIPLIER=2
```

#### 카테고리 계층 순서

| 변수   | `CATEGORY_HIERARCHY_ORDER`                                                                                           |
| ------ | -------------------------------------------------------------------------------------------------------------------- |
| 용도   | 포스트에 카테고리가 2개일 때 어느 것을 부모로 할지 결정                                                              |
| 기본값 | `first-is-parent`                                                                                                    |
| 옵션   | `first-is-parent`, `last-is-parent`                                                                                  |
| 설명   | `first-is-parent`: 첫 번째 카테고리가 부모, 두 번째가 자식. `last-is-parent`: 마지막 카테고리가 부모, 첫 번째가 자식 |

```bash
# 카테고리 계층 순서
# first-is-parent: 첫 번째 카테고리가 부모
# last-is-parent: 마지막 카테고리가 부모
CATEGORY_HIERARCHY_ORDER=first-is-parent
```

## 기본 사용법

### 도움말 표시

```bash
node dist/cli.js --help
# 또는
node dist/cli.js -h
```

### 단일 포스트 이관

특정 포스트 하나만 이관하려면 `--post` 옵션을 사용하세요:

```bash
node dist/cli.js --post=https://yourblog.tistory.com/123
```

### 전체 블로그 이관

모든 포스트를 이관하려면 `--all` 옵션을 사용하세요:

```bash
node dist/cli.js --all
```

### 내부 링크 매핑 내보내기

티스토리 포스트 간 내부 링크를 JSON 파일로 내보내려면 `--export-links` 옵션을 사용하세요:

```bash
node dist/cli.js --all --export-links
```

출력된 맵핑 파일(`output/link_mapping.json`)을 사용하여 이관 후 내부 링크를 업데이트할 수 있습니다.

### 실패 항목 재시도

이관 중 실패한 항목만 다시 시도하려면 `--retry-failed` 옵션을 사용하세요:

```bash
node dist/cli.js --all --retry-failed
```

### CLI 옵션

| 옵션             | 설명                               |
| ---------------- | ---------------------------------- |
| `-h, --help`     | 도움말 메시지 표시 후 종료         |
| `--post=<url>`   | 단일 포스트 URL로 이관             |
| `--all`          | 블로그의 모든 포스트 이관          |
| `--retry-failed` | 실패한 이관 항목 재시도            |
| `--export-links` | 내부 링크 매핑을 JSON으로 내보내기 |

## 북마크 처리

티스토리 북마크(웹사이트 미리보기)는 자동으로 감지되어 처리됩니다:

1. **감지**: 설정된 CSS 선택자(`TISTORY_BOOKMARK_SELECTOR`) 사용
2. **메타데이터 수집**: OpenGraph 메타데이터(제목, 설명, 대표이미지) 수집
3. **HTML 치환**: 원래 북마크를 사용자 정의 카드 컴포넌트로 치환
4. **이미지 처리**: 북마크 대표이미지는 별도로 다운로드/업로드되지 않음

### 북마크 카드 구조

도구는 다음 구조의 북마크 카드를 생성합니다:
[template](../src/templates/bookmarkTemplate.ts) 참고

현재 워드프레스가 A 태그 뒤에 빈 P 태그를 추가하는 문제가 있습니다.
이를 해결하기 위해 빈 P 태그를 숨기는 CSS를 추가하세요:
```css
figure.bookmark-card > p:empty {
  display: none !important;
  margin: 0 !important;
  padding: 0 !important;
}
```

### 폴백 동작

- 메타데이터 fetch 실패: URL만 사용하여 북마크 렌더링
- 대표이미지 없음: 이미지 없이 북마크 렌더링
- 설명 없음: 설명 없이 북마크 렌더링

### 북마크 설정 예시

```bash
# 티스토리 기본 테마 북마크 선택자
TISTORY_BOOKMARK_SELECTOR=figure[data-ke-type="opengraph"]
```

브라우저 개발자 도구를 사용하여 티스토리 블로그의 북마크 요소를 확인하고 적절한 CSS 선택자를 설정하세요.

## 이관 흐름

티스토리 포스트 이관 과정은 다음 순서로 진행됩니다:

```
티스토리 포스트 HTML
    ↓
[북마크 프로세서] → 북마크 감지 → 메타데이터 fetch → bookmark-card로 치환
    ↓
[클리너] → 불필요한 태그 제거 → 구조 보존
    ↓
[Turndown] → HTML → Markdown 변환
    ↓
[Marked] → Markdown → HTML 변환
    ↓
[이미지 프로세서] → 이미지 다운로드 → 워드프레스 업로드 → URL 재작성
    ↓
[워드프레스 REST API] → 카테고리, 태그, 대표이미지와 함께 포스트 생성
```

### 1. 북마크 처리

티스토리 원본 HTML에서 북마크 요소를 감지하고, OpenGraph 메타데이터를 fetch하여 표준화된 bookmark-card HTML로 치환합니다.

### 2. HTML 정제

불필요한 HTML 태그를 제거하고, 표, 볼드, 이탤릭, YouTube iframe 등의 구조를 보존합니다.

### 3. 마크다운 변환

HTML을 마크다운으로 변환한 후, 다시 HTML로 변환하여 워드프레스 블록 편집기와 호환되는 형식으로 만듭니다.

### 4. 이미지 처리

이미지를 다운로드하고 워드프레스 미디어 라이브러리에 업로드한 후, 포스트 컨텐츠의 이미지 URL을 워드프레스 URL로 변경합니다.

### 5. 워드프레스에 포스트 생성

카테고리, 태그, 대표이미지를 포함하여 워드프레스에 포스트를 생성합니다.

## 데이터베이스

이관 상태는 SQLite 데이터베이스(`data/migration.db`)에 추적됩니다:

### 테이블 구조

- `migration_jobs`: 이관 작업 추적
- `migration_job_items`: 개별 포스트 이관 상태
- `image_assets`: 이미지 업로드 추적
- `post_maps`: 티스토리 URL → 워드프레스 포스트 ID 매핑
- `internal_links`: 내부 링크 추적

### 이관 작업 관리

- `--all` 옵션으로 이관을 시작하면 이관 작업이 생성됩니다.
- 이관 작업 ID는 로그에 표시됩니다.
- 이관 중단 후 `--all`을 다시 실행하면 마지막 작업이 재개됩니다.
- `--retry-failed` 옵션으로 실패 항목만 재시도할 수 있습니다.

## 문제 해결

### 이관 실패

**문제**: 포스트 이관이 실패합니다.

**해결**:

1. 로그 파일(`LOG_FILE`) 확인
2. 환경변수 설정 확인
3. CSS 선택자가 올바른지 브라우저 개발자 도구로 확인
4. 워드프레스 REST API가 활성화되어 있는지 확인
5. 워드프레스 애플리케이션 비밀번호가 올바른지 확인

### 이미지 업로드 실패

**문제**: 이미지가 워드프레스에 업로드되지 않습니다.

**해결**:

1. 워드프레스 미디어 라이브러리 권한 확인
2. 워드프레스 업로드 크기 제한 확인
3. 티스토리 이미지 URL이 접근 가능한지 확인

### 북마크 메타데이터 fetch 실패

**문제**: 북마크 메타데이터가 fetch되지 않습니다.

**해결**:

1. 북마크 URL이 접근 가능한지 확인
2. 대상 웹사이트에 OpenGraph 태그가 있는지 확인
3. 타임아웃 설정(`10초`) 확인
4. 로그에서 fetch 실패 원인 확인

### CSS 선택자 오류

**문제**: 포스트 메타데이터가 추출되지 않습니다.

**해결**:

1. 브라우저 개발자 도구(F12)를 사용하여 요소 검사
2. 올바른 CSS 선택자 확인
3. 티스토리 테마가 변경되지 않았는지 확인
4. 테스트 포스트에 대해 크롤러가 올바르게 작동하는지 로그 확인

## 추가 정보

더 자세한 내용은 다음 문서를 참고하세요:

- [기능 스펙](spec.md) - 제공 기능 및 한계점
- [시퀀스 다이어그램](sequence-diagram.md) - 주요 동작 흐름

## 지원

문제가 발생하면 이슈를 생성하거나 프로젝트 문서를 참고하세요.
