# 기능 스펙

이 문서에서는 Tistory2Wordpress 도구가 제공하는 기능과 현재 한계점을 설명합니다.

## 목차

1. [제공 기능](#제공-기능)
2. [한계점](#한계점)
3. [기술 제약사항](#기술-제약사항)
4. [향후 개선 사항](#향후-개선-사항)

## 제공 기능

### 1. CLI 도움말

도구의 사용법을 쉽게 이해할 수 있도록 도움말 옵션을 제공합니다.

**기능**:

- `--help` 또는 `-h` 옵션으로 도움말 표시
- 도구 설명, 사용법, 옵션 목록 표시
- 환경변수 목록 및 설명 표시
- 도움말 표시 후 즉시 종료 (코드 0)
- 환경설정 로드 전에 도움말 확인

**사용 예시**:

```bash
node dist/cli.js --help
node dist/cli.js -h
```

### 2. 티스토리 블로그 크롤링

티스토리 블로그에서 포스트 URL과 메타데이터를 추출합니다.

**기능**:

- 리스트 페이지 크롤링으로 전체 포스트 URL 발견
- 페이지네이션 처리 (다음 페이지 자동 감지)
- 각 포스트의 메타데이터 추출:
  - 제목
  - 발행일
  - 수정일
  - 카테고리
  - 태그
  - 대표이미지 URL
  - 컨텐츠 HTML
- 설정 가능한 CSS 선택자로 유연한 메타데이터 추출
- 재시도 메커니즘 (백오프 포함)

**사용자 정의**:

- 티스토리 테마에 맞는 CSS 선택자 설정 가능
- 작업자 수 및 요청 속도 조절 가능

### 3. 북마크 처리

티스토리 북마크(웹사이트 미리보기)를 자동으로 감지하고 처리합니다.

**기능**:

- CSS 선택자로 북마크 요소 감지
- 각 북마크 URL에서 OpenGraph 메타데이터 fetch:
  - 제목 (og:title → title → URL)
  - 설명 (og:description → 빈 문자열)
  - 대표이미지 (og:image → favicon → 빈 문자열)
  - URL (og:url → 원본 URL)
- HTTP 요청 설정:
  - 타임아웃: 10초
  - 최대 리디렉션: 5회
  - User-Agent 헤더 설정
  - 재시도 메커니즘 (백오프 포함)
- 사용자 정의 북마크 카드 HTML 생성:
  - HTML 이스케이프로 XSS 방지
  - 옵셔널 필드 graceful handling (이미지/설명 없는 경우)
- 폴백 동작:
  - 메타데이터 fetch 실패 시 URL만 사용하여 렌더링
  - featuredImage 없으면 이미지 블록 제거
  - description 없으면 설명 블록 제거

**북마크 카드 구조**:

- `src/templates/bookmark-template.html`에서 확인 및 수정 가능 

**보안**:

- 모든 사용자 입력 HTML 이스케이프
- 외부 링크에 `target="_blank"` 및 `rel="noopener noreferrer"` 적용

### 4. HTML 정제

티스토리 원본 HTML을 워드프레스 블록 편집기 호환 형식으로 정제합니다.

**기능**:

- HTML → Markdown → HTML 변환 (Turndown → Marked)
- 구조 보존:
  - 표 (table)
  - 볼드 (strong, b)
  - 이탤릭 (em, i)
  - 윗첨자/아랫첨자 (sup, sub)
  - YouTube iframe
  - 북마크 카드 (figure.bookmark-card)
  - 블록퀴트 (blockquote)
- 불필요한 태그 제거
- 워드프레스 블록 편집기 호환 HTML 생성

### 5. 이미지 처리

티스토리 이미지를 워드프레스 미디어 라이브러리로 마이그레이션합니다.

**기능**:

- 정제된 HTML에서 이미지 요소 감지
- 북마크 내 이미지 자동 제외 (figure.bookmark-card 내부)
- 이미지 다운로드:
  - axios HTTP GET으로 다운로드
  - 재시도 메커니즘 (백오프 포함)
  - ArrayBuffer로 다운로드
- 워드프레스 미디어 라이브러리 업로드:
  - REST API /wp/v2/media 엔드포인트 사용
  - MIME 타입 감지
  - 파일명 생성 (포스트 제목 + 인덱스)
  - alt 텍스트 설정
- 이미지 URL 치환:
  - 티스토리 URL → 워드프레스 URL
  - 이미지 소스 속성 업데이트
- 이미지 자산 추적:
  - image_assets 테이블에 업로드 상태 저장
  - 실패 시 에러 메시지 저장

**대표이미지 처리**:

- 별도의 processFImg() 함수로 처리
- 포스트 메타데이터에서 추출된 대표이미지 업로드
- 워드프레스 포스트의 featured_image_id로 설정

### 6. 워드프레스 REST API 통합

워드프레스 REST API를 사용하여 포스트를 생성합니다.

**기능**:

- 카테고리 관리:
  - ensureCategory(name, parentId): 존재하면 ID 반환, 없으면 생성
  - 계층 구조 지원 (부모-자식 카테고리)
- 태그 관리:
  - ensureTag(name): 존재하면 ID 반환, 없으면 생성
- 포스트 생성:
  - REST API /wp/v2/posts 엔드포인트 사용
  - 초안 상태 (draft)로 생성
  - 제목, 컨텐츠, 발행일 설정
  - 카테고리 ID 목록 연결
  - 태그 ID 목록 연결
  - 대표이미지 ID 설정
- 인증:
  - 애플리케이션 비밀번호 (Application Password)
  - Basic Authentication 헤더

### 7. 내부 링크 추적

티스토리 포스트 간 내부 링크를 추적합니다.

**기능**:

- 정제된 HTML에서 내부 링크 감지
  - 링크 텍스트, URL, 컨텍스트 추출
- internal_links 테이블에 저장:
  - source_job_item_id
  - target_tistory_url
  - link_text
  - context (주변 컨텐츠)
- 맵핑 내보내기:
  - exportLinkMapping() 함수로 JSON 파일 내보내기
  - 이관 후 내부 링크 URL 업데이트에 사용 가능

### 8. 이관 상태 추적

SQLite 데이터베이스로 이관 상태를 추적합니다.

**기능**:

- migration_jobs 테이블:
  - 이관 작업 추적 (SINGLE, FULL)
  - 상태, 완료시간, 에러 메시지 저장
- migration_job_items 테이블:
  - 개별 포스트 이관 상태
  - 상태: PENDING, PROCESSING, COMPLETED, FAILED
  - 티스토리 URL, 워드프레스 포스트 ID 저장
- image_assets 테이블:
  - 이미지 업로드 상태
  - 상태: UPLOADING, UPLOADED, FAILED
  - 티스토리 URL, 워드프레스 미디어 ID 저장
- post_maps 테이블:
  - 티스토리 URL → 워드프레스 포스트 ID 매핑
  - 이관 후 내부 링크 업데이트에 사용
- internal_links 테이블:
  - 내부 링크 추적
  - 소스/타겟 URL, 링크 텍스트, 컨텍스트 저장

**작업 관리**:

- 실행 중인 작업 재개 지원
- 완료 항목 스킵
- 실패 항목 선택적 재시도 (--retry-failed)

### 9. 작업자 풀 (Worker Pool)

병렬 처리로 이관 속도를 높입니다.

**기능**:

- p-queue 라이브러리로 작업 큐 관리
- 동시 작업자 수 설정 가능 (WORKER_COUNT)
- 작업자당 요청 속도 제한 (RATE_LIMIT_PER_WORKER)
- 요청 간 지연으로 서버 과부하 방지
- PostProcessor가 작업자 풀 관리

### 10. 재시도 메커니즘

실패한 작업을 자동으로 재시도합니다.

**기능**:

- exponential backoff:
  - 초기 지연: RETRY_INITIAL_DELAY_MS (기본 500ms)
  - 백오프 배수: RETRY_BACKOFF_MULTIPLIER (기본 2)
  - 최대 지연: RETRY_MAX_DELAY_MS (기본 10000ms)
- 최대 재시도 횟수: MAX_RETRY_ATTEMPTS (기본 3)
- 적용 대상:
  - HTTP 요청 (크롤링, 이미지 다운로드)
  - 북마크 메타데이터 fetch
  - 워드프레스 API 요청

### 11. 롤백 메커니즘

포스트 이관 실패 시 롤백합니다.

**기능**:

- best-effort 롤백 (일부 실패해도 계속 진행)
- 롤백 대상:
  - 업로드된 대표이미지 삭제
  - 업로드된 컨텐츠 이미지 삭제
  - 생성된 워드프레스 포스트 삭제
- 롤백 실패 시 로그만 기록하고 계속
- migration_job_items 상태를 FAILED로 업데이트
- 에러 메시지 저장

### 12. 로깅

상세한 로그를 제공합니다.

**기능**:

- 로그 레벨: DEBUG, INFO, WARN, ERROR
- 구조화된 로그 (JSON 형식):
  - 타임스탬프
  - 레벨
  - 메시지
  - 컨텍스트 데이터
- 파일 로그 지원 (LOG_FILE 환경변수)
- 주요 이벤트 로깅:
  - 포스트 발견
  - 북마크 감지
  - 메타데이터 fetch
  - 이미지 업로드
  - 포스트 이관 성공/실패
  - 롤백 진행

## 한계점

### 1. 티스토리 테마 의존성

**문제**: CSS 선택자가 티스토리 테마에 의존합니다.

**영향**:

- 각 티스토리 블로그에 맞는 CSS 선택자를 수동으로 설정해야 함
- 테마 변경 시 선택자 재설정 필요
- 일부 테마에서는 메타데이터 추출이 불가능할 수 있음

**완화**:

- 브라우저 개발자 도구로 요소 검사 가능
- 테스트 포스트로 선택자 확인 가능

### 2. 북마크 메타데이터 fetch 제한

**문제**: 모든 웹사이트가 OpenGraph 메타데이터를 제공하지 않습니다.

**영향**:

- 일부 북마크는 제목만 표시 (URL 사용)
- 설명이나 대표이미지가 누락될 수 있음
- 메타데이터가 없는 웹사이트는 폴백 동작으로 처리

**완화**:

- 폴백으로 \<title\> 태그 사용
- favicon 폴백
- URL만 표시하더라도 북마크 카드 구조 유지

### 3. 북마크 메타데이터 캐싱 없음

**문제**: 북마크 메타데이터가 캐싱되지 않습니다.

**영향**:

- 동일한 URL이 여러 번 fetch될 수 있음 (여러 포스트에 같은 북마크)
- 네트워크 요청 수 증가
- 이관 속도 저하 가능성

**이유**: 스펙에서 메타데이터 캐싱이 명시적으로 금지됨

**완화**:

- 재시도 메커니즘으로 일시적 실패 대응
- 타임아웃이 비교적 짧음 (10초)

### 4. 이미지 업로드 제한

**문제**: 이미지 업로드 시 추가 처리 없음.

**영향**:

- 이미지 압축/최적화 없음
- 원본 크기 그대로 업로드
- 워드프레스 미디어 라이브러리 공간 사용량 증가

**완화**:

- 워드프레스 자체 이미지 최적화 플러그인 사용 가능
- 필요시 별도 이미지 최적화 도구 사용

### 5. 내부 링크 자동 업데이트 없음

**문제**: 이관 후 내부 링크가 자동으로 업데이트되지 않습니다.

**영향**:

- 내부 링크가 여전히 티스토리 URL을 가리킴
- export-links로 내보낸 매핑 파일을 사용하여 수동 업데이트 필요
- 추가 스크립트나 수동 작업 필요

**완화**:

- internal_links 테이블에 모든 내부 링크 추적
- exportLinkMapping()으로 JSON 매핑 파일 제공
- 매핑 파일을 사용하여 자동 업데이트 스크립트 작성 가능

### 6. 댓글 이관 미지원

**문제**: 댓글이 이관되지 않습니다.

**영향**:

- 댓글이 워드프레스로 이관되지 않음
- 댓글 관련 데이터 손실

**이유**: 현재 스펙에서 댓글 이관이 포함되지 않음

### 7. 첨부파일 이관 미지원

**문제**: 첨부파일이 이관되지 않습니다.

**영향**:

- 첨부파일이 워드프레스로 이관되지 않음
- 첨부파일 관련 데이터 손실

**이유**: 현재 스펙에서 첨부파일 이관이 포함되지 않음

### 8. 포스트 URL 구조 변경

**문제**: 이관 후 포스트 URL이 변경됩니다.

**영향**:

- 티스토리 URL과 워드프레스 URL이 다름
- 외부 링크가 끊어질 수 있음
- SEO 영향 가능성

**완화**:

- 워드프레스에서 URL 리디렉션 설정 가능
- 워드프레스 플러그인으로 URL 구조 유지 가능

### 9. 단일 스레드 이관

**문제**: 모든 이관 작업이 단일 스레드에서 순차적으로 수행됩니다.

**영향**:

- 대규모 블로그 이관 시 시간 소요
- 작업자 풀은 병렬 처리하지만, 전체 이관은 순차적

**완화**:

- 작업자 수와 요청 속도 조절 가능
- 완료 항목 스킵으로 중단 후 재개 가능

### 10. 에러 복구 한계

**문제**: 일부 에러는 자동으로 복구되지 않습니다.

**영향**:

- 워드프레스 API 오류 시 수동 개입 필요
- 티스토리 서비스 장애 시 이관 중단
- 데이터베이스 오류 시 수동 복구 필요

**완화**:

- 롤백 메커니즘으로 부분 실패 대응
- 재시도 메커니즘으로 일시적 오류 대응
- 상세 로그로 문제 진단 가능

## 기술 제약사항

### 1. 워드프레스 REST API 의존성

워드프레스 REST API v2 (/wp/v2/\*)를 사용합니다.

**요구사항**:

- 워드프레스 4.7 이상
- REST API 활성화
- 애플리케이션 비밀번호 인증

### 2. SQLite 데이터베이스

SQLite를 마이그레이션 상태 추적에 사용합니다.

**특성**:

- 파일 기반 데이터베이스
- 트랜잭션 지원
- 단일 쓰기 접근

### 3. Node.js 환경

Node.js 18 이상이 필요합니다.

**특성**:

- 비동기 I/O (async/await)
- ES6+ 문법 사용

### 4. 네트워크 요구사항

인터넷 연결이 필요합니다.

**필요 연결**:

- 티스토리 블로그 접근
- 북마크 URL 접근
- 워드프레스 REST API 접근

## 향후 개선 사항

1. **내부 링크 자동 업데이트**
   - 이관 후 자동으로 내부 링크 URL 업데이트
   - export-links 필요 없음

2. **진행률 표시**
   - 현재 진행률 퍼센트 표시
   - 예상 완료 시간 표시

3. **웹 UI**
   - CLI 대신 웹 인터페이스 제공
   - 사용자 친화성 향상
